<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTMET — Danh sách bạn bè</title>
  <style>
    :root{--bg:#0b1b2b;--surface:#101820;--accent:#2196f3;--muted:#9fb0bd;--card-radius:12px;--text:#e8eaed}
    body{margin:0;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:var(--text)}
    header{display:flex;align-items:center;gap:12px;padding:18px;background:linear-gradient(90deg,rgba(33,150,243,0.06),transparent);box-shadow:0 6px 20px rgba(0,0,0,0.4)}
    .logo{width:44px;height:44;border-radius:10px;background:linear-gradient(135deg,var(--accent),#64b5f6);display:flex;align-items:center;justify-content:center;font-weight:800}
    .container{max-width:1100px;margin:18px auto;display:grid;grid-template-columns:320px 1fr;gap:18px;padding:0 16px}
    .card{background:var(--surface);padding:16px;border-radius:var(--card-radius);box-shadow:0 8px 40px rgba(0,0,0,0.5)}
    h2{margin:0 0 10px}
    .userItem{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px}
    .inboxItem{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
  </style>
</head>
<body>
  <header>
    <div class="logo">M</div>
    <div>
      <div style="font-weight:700">MTMET</div>
      <div style="font-size:12px;color:var(--muted)">Gọi nhóm • Giao diện Meet-like</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <div id="meDisplay" class="muted">...</div>
      <button id="btnCreateRoom" class="btn">Tạo phòng</button>
      <button id="btnLogout" class="btn ghost">Đăng xuất</button>
    </div>
  </header>

  <div class="container">
    <div>
      <div class="card">
        <h2>Danh sách bạn bè</h2>
        <div id="friendsList">...</div>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />
        <div>
          <input id="searchUser" placeholder="Tìm người (username)" style="width:100%;padding:8px;border-radius:8px;background:#0b1115;border:1px solid #17202a;color:var(--text)" />
          <div id="searchResults" style="margin-top:10px"></div>
        </div>
      </div>

      <div style="height:18px"></div>
      <div class="card">
        <h2>Hộp thư lời mời</h2>
        <div id="inbox">...</div>
      </div>
    </div>

    <div>
      <div class="card">
        <h2>Thông tin</h2>
        <div id="profile"></div>
      </div>

      <div style="height:18px"></div>
      <div class="card">
        <h2>Hoạt động phòng</h2>
        <div id="roomsArea">Tạo phòng và mời bạn</div>
      </div>
    </div>
  </div>

  <script src="firebase-config.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import { getDatabase, ref, set, onValue, push, get, update, remove } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

    const app = initializeApp(window.FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const meDisplay = document.getElementById('meDisplay');
    const btnCreateRoom = document.getElementById('btnCreateRoom');
    const btnLogout = document.getElementById('btnLogout');
    const friendsList = document.getElementById('friendsList');
    const searchUser = document.getElementById('searchUser');
    const searchResults = document.getElementById('searchResults');
    const inbox = document.getElementById('inbox');
    const profile = document.getElementById('profile');
    const roomsArea = document.getElementById('roomsArea');

    let me = null; // { uid, username, displayName }

    function elt(tag, attrs={}, txt=''){ const e=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k,v)); if(txt) e.innerText=txt; return e; }

    onAuthStateChanged(auth, async user => {
      if(!user){ location.href = 'login.html'; return; }
      const uid = user.uid;
      const snap = await get(ref(db, `users/${uid}`));
      const data = snap.val();
      me = { uid, username: data.username, displayName: data.displayName };
      meDisplay.innerText = me.displayName;
      renderProfile(data);
      watchFriends();
      watchInbox();
    });

    btnLogout.onclick = async ()=>{ await signOut(auth); location.href='login.html'; };

    function renderProfile(data){ profile.innerHTML = `<div><strong>${data.displayName}</strong> (${data.username})</div><div class=\"muted\">UID: ${Object.keys(data||{}).length? '...':''}</div>`; }

    // FRIENDS
    function watchFriends(){
      if(!me) return;
      onValue(ref(db, `users/${me.uid}/friends`), snapshot=>{
        const val = snapshot.val() || {};
        friendsList.innerHTML = '';
        const uids = Object.keys(val || {});
        if(uids.length===0) friendsList.innerHTML = '<div class="muted">Bạn chưa có bạn bè</div>';
        uids.forEach(async uid=>{
          const s = await get(ref(db, `users/${uid}`)); const u = s.val();
          const item = elt('div',{class:'userItem'});
          const left = elt('div',{}, u.displayName + ' ('+u.username+')');
          const right = elt('div');
          const btnInvite = elt('button',{class:'btn'}, 'Mời');
          btnInvite.onclick = ()=> inviteToRoom(uid);
          right.appendChild(btnInvite);
          item.appendChild(left); item.appendChild(right);
          friendsList.appendChild(item);
        });
      });
    }

    // SEARCH USERS & SEND FRIEND REQUEST
    searchUser.addEventListener('keydown', async e=>{ if(e.key==='Enter') doSearch(); });
    async function doSearch(){
      const q = searchUser.value.trim(); if(!q) return;
      // naive scan all users (for demo). For production, add index or cloud function.
      const snap = await get(ref(db, 'users'));
      const all = snap.val() || {};
      searchResults.innerHTML = '';
      Object.entries(all).forEach(([uid,u])=>{
        if(u.username && u.username.indexOf(q)!==-1 && uid !== (me && me.uid)){
          const row = elt('div',{class:'userItem'});
          row.innerHTML = `<div>${u.displayName} (${u.username})</div>`;
          const btn = document.createElement('button'); btn.className='btn ghost'; btn.innerText='Kết bạn';
          btn.onclick = ()=> sendFriendRequest(uid, u.username, u.displayName);
          row.appendChild(btn);
          searchResults.appendChild(row);
        }
      });
    }

    async function sendFriendRequest(targetUid, targetUsername, targetDisplay){
      if(!me) return alert('Chưa đăng nhập');
      // write to /friendRequests/{targetUid}/{fromUid}
      await set(ref(db, `friendRequests/${targetUid}/${me.uid}`), { from: me.uid, name: me.displayName, username: me.username, time: Date.now() });
      alert('Đã gửi lời mời');
    }

    // INBOX: watch friend requests and room invites
    function watchInbox(){
      if(!me) return;
      onValue(ref(db, `friendRequests/${me.uid}`), snapshot=>{
        const val = snapshot.val() || {};
        inbox.innerHTML = '<div style="font-weight:700;margin-bottom:6px">Lời mời kết bạn</div>';
        Object.entries(val).forEach(([fromUid, req])=>{
          const el = elt('div',{class:'inboxItem'});
          el.innerHTML = `<div>${req.name} (${req.username})</div>`;
          const accept = elt('button',{class:'btn'}, 'Chấp nhận');
          const decline = elt('button',{class:'btn ghost'}, 'Từ chối');
          accept.onclick = async ()=>{
            // add both to friends list
            await set(ref(db, `users/${me.uid}/friends/${fromUid}`), true);
            await set(ref(db, `users/${fromUid}/friends/${me.uid}`), true);
            await remove(ref(db, `friendRequests/${me.uid}/${fromUid}`));
          };
          decline.onclick = async ()=>{ await remove(ref(db, `friendRequests/${me.uid}/${fromUid}`)); };
          el.appendChild(accept); el.appendChild(decline);
          inbox.appendChild(el);
        });
      });

      // room invites
      onValue(ref(db, `invites/${me.uid}`), snapshot=>{
        const val = snapshot.val() || {};
        const keys = Object.keys(val||{});
        if(keys.length) {
          const title = elt('div',{}, '\nLời mời vào phòng'); inbox.appendChild(title);
          keys.forEach(k=>{
            const it = val[k];
            const el = elt('div',{class:'inboxItem'});
            el.innerHTML = `<div>${it.fromName} mời bạn vào phòng <strong>${it.room}</strong></div>`;
            const joinBtn = elt('button',{class:'btn'}, 'Tham gia');
            const ignore = elt('button',{class:'btn ghost'}, 'Bỏ qua');
            joinBtn.onclick = ()=>{ // go to call page with room
              location.href = `call.html?room=${encodeURIComponent(it.room)}`;
            };
            ignore.onclick = ()=> remove(ref(db, `invites/${me.uid}/${k}`));
            el.appendChild(joinBtn); el.appendChild(ignore);
            inbox.appendChild(el);
          });
        }
      });
    }

    // CREATE ROOM and INVITE
    btnCreateRoom.onclick = async ()=>{
      if(!me) return alert('Chưa đăng nhập');
      const roomId = 'room_' + Math.random().toString(36).slice(2,9);
      // create room node
      await set(ref(db, `rooms/${roomId}`), { createdBy: me.uid, createdAt: Date.now() });
      // open call page
      location.href = `call.html?room=${encodeURIComponent(roomId)}`;
    };

    async function inviteToRoom(targetUid){
      if(!me) return alert('Chưa đăng nhập');
      const room = prompt('Nhập room ID (hoặc tạo phòng trước)');
      if(!room) return;
      // write invite under invites/{targetUid}/{randomKey}
      const k = 'i_' + Math.random().toString(36).slice(2,9);
      await set(ref(db, `invites/${targetUid}/${k}`), { from: me.uid, fromName: me.displayName, room, time: Date.now() });
      alert('Đã gửi lời mời');
    }
  </script>
</body>
</html>
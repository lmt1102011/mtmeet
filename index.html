<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MTMET - Danh sách bạn bè</title>
<style>
body{margin:0;font-family:Arial;background:#0b1b2b;color:#e8eaed}
header{padding:12px;background:#12161a;display:flex;justify-content:space-between;align-items:center}
.container{display:flex;gap:12px;padding:12px}
.card{background:#12161a;padding:12px;border-radius:12px;flex:1}
button{cursor:pointer}
input{width:100%;padding:6px;border-radius:6px;border:1px solid #17202a;background:#0b1115;color:#e8eaed}
.small{font-size:13px;color:#9fb0bd}
</style>
</head>
<body>
<header>
  <div id="meDisplay">...</div>
  <button id="btnLogout">Đăng xuất</button>
</header>
<div class="container">
  <div class="card">
    <h3>Danh sách bạn bè</h3>
    <div id="friendsList">Đang tải...</div>
    <hr>
    <input id="searchUser" placeholder="Tìm người">
    <button id="btnSearch">Tìm</button>
    <div id="searchResults"></div>
  </div>
</div>

<script src="firebase-config.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { getDatabase, ref, get, set, push, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

const app = initializeApp(window.FIREBASE_CONFIG);
const db = getDatabase(app);

let me = JSON.parse(localStorage.getItem('user'));
if(!me) location.href='login.html';

document.getElementById('meDisplay').innerText = me.displayName;

document.getElementById('btnLogout').onclick = ()=>{
  localStorage.removeItem('user');
  location.href='login.html';
};

const friendsList = document.getElementById('friendsList');
const searchUser = document.getElementById('searchUser');
const btnSearch = document.getElementById('btnSearch');
const searchResults = document.getElementById('searchResults');

function elt(tag,attrs={},txt=''){ const e=document.createElement(tag); for(const k in attrs) e.setAttribute(k,attrs[k]); if(txt) e.innerText=txt; return e; }

async function renderFriends(){
  const snap = await get(ref(db,`users/${me.uid}/friends`));
  const friends = snap.val() || {};
  friendsList.innerHTML = '';
  if(Object.keys(friends).length===0){ friendsList.innerText='Chưa có bạn bè'; return; }
  for(const fid in friends){
    const fSnap = await get(ref(db,`users/${fid}`));
    const f = fSnap.val(); if(!f) continue;
    const row = elt('div',{}, `${f.displayName} (${f.username})`);
    friendsList.appendChild(row);
  }
}

async function searchNow(){
  const q = searchUser.value.trim().toLowerCase();
  searchResults.innerHTML='';
  if(!q) return;
  const allSnap = await get(ref(db,'users'));
  const all = allSnap.val()||{};
  for(const uid in all){
    if(uid===me.uid) continue;
    const u = all[uid];
    if((u.username||'').toLowerCase().includes(q) || (u.displayName||'').toLowerCase().includes(q)){
      const row = elt('div',{}, `${u.displayName} (${u.username})`);
      searchResults.appendChild(row);
    }
  }
}

btnSearch.onclick = searchNow;
searchUser.onkeydown = e=>{if(e.key==='Enter') searchNow();}

renderFriends();
</script>
</body>
</html>

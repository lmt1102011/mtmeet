<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTMET ‚Äî G·ªçi nh√≥m</title>

  <style>
    :root{
      --bg:#0b1b2b;
      --surface:#101820;
      --accent:#2196f3;
      --text:#e8eaed;
      --muted:#9fb0bd;
    }
    body{
      margin:0;
      font-family:Inter,Segoe UI,Arial;
      background:var(--bg);
      color:var(--text);
    }
    header{
      display:flex;align-items:center;gap:12px;
      padding:12px 18px;
      background:linear-gradient(90deg,rgba(33,150,243,0.06),transparent);
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#64b5f6);display:flex;align-items:center;justify-content:center;font-weight:700}
    
    .stage{
      display:grid;gap:12px;
      padding:18px;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    }
    .tile{
      background:#000;border-radius:18px;
      overflow:hidden;position:relative;
      min-height:180px;
      box-shadow:0 10px 40px rgba(0,0,0,0.4);
    }
    video{width:100%;height:100%;object-fit:cover;}

    .nameTag{
      position:absolute;left:12px;bottom:12px;
      background:rgba(0,0,0,0.45);
      padding:6px 12px;border-radius:10px;
      font-size:13px;
      display:flex;align-items:center;gap:6px;
    }
    .micIcon{
      width:14px;height:14px;border-radius:50%;
      background:#f44336;
    }
    .micOn{background:#00e676!important;}

    .avatar{
      width:100%;height:100%;display:flex;align-items:center;justify-content:center;
      font-size:40px;font-weight:700;
      background:#263238;color:#90a4ae;
    }

    .controls{
      position:fixed;bottom:22px;left:50%;transform:translateX(-50%);
      background:var(--surface);
      padding:12px 16px;
      border-radius:40px;
      display:flex;gap:12px;
      box-shadow:0 10px 60px rgba(0,0,0,0.6);
    }
    .controlBtn{
      width:46px;height:46px;border-radius:50%;border:none;
      background:var(--accent);color:#fff;
      cursor:pointer;font-size:14px;font-weight:600;
      display:flex;align-items:center;justify-content:center;
      transition:0.2s;
    }
    .controlBtn:hover{filter:brightness(1.15);}
    .danger{background:#e53935!important;}
  </style>
</head>

<body>
  <header>
    <div class="logo">M</div>
    <div>
      <div id="roomTitle" style="font-weight:700;font-size:16px">Ph√≤ng</div>
      <div id="meInfo" style="font-size:12px;color:var(--muted)">...</div>
    </div>
  </header>

  <div id="stage" class="stage"></div>

  <div class="controls">
    <button id="muteBtn" class="controlBtn">üé§</button>
    <button id="camBtn" class="controlBtn">üé•</button>
    <button id="leaveBtn" class="controlBtn danger">‚úñ</button>
  </div>

  <script src="firebase-config.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getDatabase, ref, onValue, push, set, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

    const app = initializeApp(window.FIREBASE_CONFIG);
    const db = getDatabase(app);

    const uid = localStorage.getItem('uid');
    if(!uid) location.href='login.html';

    let me = null;
    let roomId = new URL(location.href).searchParams.get('room');
    if(!roomId){
      roomId = prompt("Room ID?");
      if(!roomId) location.href='index.html';
    }

    const stage = document.getElementById('stage');
    const meInfo = document.getElementById('meInfo');
    const roomTitle = document.getElementById('roomTitle');
    roomTitle.innerText = "Ph√≤ng: " + roomId;

    let localStream;
    const pcs = {};
    const tiles = {};

    function elt(tag,attrs={},txt=''){const e=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k,v));if(txt)e.innerText=txt;return e;}

    // Load profile
    onValue(ref(db,`users/${uid}`),snap=>{
      me = snap.val();
      if(!me) return;
      meInfo.innerText = me.displayName;
      initCall();
    });

    async function initCall(){
      try{
        localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      }catch(e){
        alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c cam/mic");
        return;
      }

      addLocalTile();
      joinRoom();
      watchParticipants();
      watchSignals();
    }

    function joinRoom(){
      const pRef = ref(db,`rooms/${roomId}/participants/${uid}`);
      set(pRef,{ name:me.displayName, mic:true, cam:true });
      onDisconnect(pRef).remove();
    }

    function addLocalTile(){
      const tile=createTile(uid,me.displayName);
      tile.video.srcObject=localStream;
      tiles[uid].video.muted=true;
      detectVoice(uid);
    }

    function createTile(id,name){
      if(tiles[id]) return tiles[id];

      const t=elt('div',{class:'tile'});
      const v=document.createElement('video');
      v.autoplay=true;v.playsInline=true;
      const av=elt('div',{class:'avatar'},name[0].toUpperCase());
      const tag=elt('div',{class:'nameTag'},name);
      const micIcon=elt('div',{class:'micIcon'});
      tag.appendChild(micIcon);

      t.appendChild(v);
      t.appendChild(av);
      t.appendChild(tag);
      stage.appendChild(t);

      tiles[id]={el:t, video:v, avatar:av, micIcon};

      return tiles[id];
    }

    // Participants changes
    function watchParticipants(){
      onValue(ref(db,`rooms/${roomId}/participants`),snap=>{
        const list=snap.val()||{};
        Object.keys(list).forEach(pid=>{
          if(pid!==uid && !pcs[pid]) createOffer(pid,list[pid].name);
          updateMedia(pid,list[pid]);
        });
        Object.keys(pcs).forEach(k=>{ if(!list[k]) removePeer(k); });
      });
    }

    function updateMedia(pid,data){
      if(!tiles[pid]) return;
      tiles[pid].avatar.style.display = data.cam? 'none':'flex';
      tiles[pid].video.style.display  = data.cam? 'block':'none';
      tiles[pid].micIcon.classList.toggle('micOn',data.mic);
    }

    // Signaling
    function watchSignals(){
      onValue(ref(db,`rooms/${roomId}/signals/${uid}`),snap=>{
        const msgs=snap.val()||{};
        Object.entries(msgs).forEach(([k,v])=>{
          handleSignal(k,v);
          remove(ref(db,`rooms/${roomId}/signals/${uid}/${k}`));
        });
      });
    }

    async function createOffer(pid,name){
      const pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
      pcs[pid]=pc;

      createTile(pid,name);
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

      pc.ontrack=e=> tiles[pid].video.srcObject=e.streams[0];

      pc.onicecandidate=e=>{
        if(e.candidate)
          push(ref(db,`rooms/${roomId}/signals/${pid}`),{from:uid,ice:e.candidate.toJSON()});
      };

      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
      push(ref(db,`rooms/${roomId}/signals/${pid}`),{from:uid,offer:offer.sdp,name:me.displayName});
    }

    async function handleSignal(from,data){
      if(!pcs[from]){
        const pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
        pcs[from]=pc;

        createTile(from,data.name);
        localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
        pc.ontrack=e=> tiles[from].video.srcObject=e.streams[0];
        pc.onicecandidate=e=>{
          if(e.candidate)
            push(ref(db,`rooms/${roomId}/signals/${from}`),{from:uid,ice:e.candidate.toJSON()});
        };
      }
      const pc=pcs[from];

      if(data.offer){
        await pc.setRemoteDescription({type:'offer',sdp:data.offer});
        const ans=await pc.createAnswer();
        await pc.setLocalDescription(ans);
        push(ref(db,`rooms/${roomId}/signals/${from}`),{from:uid,answer:ans.sdp});
      }
      else if(data.answer){
        await pc.setRemoteDescription({type:'answer',sdp:data.answer});
      }
      else if(data.ice){
        try{ await pc.addIceCandidate(new RTCIceCandidate(data.ice)); }catch(e){}
      }
    }

    function removePeer(pid){
      if(pcs[pid]) pcs[pid].close();
      delete pcs[pid];
      if(tiles[pid]) tiles[pid].el.remove();
      delete tiles[pid];
    }

    // Controls
    muteBtn.onclick=()=>{
      const t=localStream.getAudioTracks()[0];
      t.enabled=!t.enabled;
      set(ref(db,`rooms/${roomId}/participants/${uid}/mic`),t.enabled);
      muteBtn.style.background=t.enabled?'var(--accent)':'#e53935';
    };
    camBtn.onclick=()=>{
      const t=localStream.getVideoTracks()[0];
      t.enabled=!t.enabled;
      set(ref(db,`rooms/${roomId}/participants/${uid}/cam`),t.enabled);
      camBtn.style.background=t.enabled?'var(--accent)':'#e53935';
    };

    leaveBtn.onclick=()=>{
      remove(ref(db,`rooms/${roomId}/participants/${uid}`));
      location.href='index.html';
    };

    // Voice detect
    function detectVoice(pid){
      const v=new (window.AudioContext||webkitAudioContext)();
      const src=v.createMediaStreamSource(localStream);
      const analyser=v.createAnalyser();
      src.connect(analyser);
      const arr=new Uint8Array(analyser.frequencyBinCount);

      function loop(){
        analyser.getByteFrequencyData(arr);
        const vol=arr.reduce((a,b)=>a+b)/arr.length;
        if(tiles[pid]) tiles[pid].micIcon.classList.toggle('micOn',vol>30);
        requestAnimationFrame(loop);
      }
      loop();
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTMET — Danh sách bạn bè</title>
  <style>
    :root{--bg:#0b1b2b;--surface:#101820;--accent:#2196f3;--muted:#9fb0bd;--card-radius:12px;--text:#e8eaed}
    body{margin:0;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:var(--text)}
    header{display:flex;align-items:center;gap:12px;padding:18px;background:linear-gradient(90deg,rgba(33,150,243,0.06),transparent);box-shadow:0 6px 20px rgba(0,0,0,0.4)}
    .logo{width:44px;height:44;border-radius:10px;background:linear-gradient(135deg,var(--accent),#64b5f6);display:flex;align-items:center;justify-content:center;font-weight:800}
    .container{max-width:1100px;margin:18px auto;display:grid;grid-template-columns:320px 1fr;gap:18px;padding:0 16px}
    .card{background:var(--surface);padding:16px;border-radius:var(--card-radius);box-shadow:0 8px 40px rgba(0,0,0,0.5)}
    h2{margin:0 0 10px}
    .userItem{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
    .btn:hover{opacity:0.95}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent)}
    .muted{color:var(--muted)}
    .inboxItem{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    input{width:100%;padding:8px;border-radius:8px;background:#0b1115;border:1px solid #17202a;color:var(--text)}
    .row{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="logo">M</div>
    <div>
      <div style="font-weight:700">MTMET</div>
      <div style="font-size:12px;color:var(--muted)">Gọi nhóm • Giao diện Meet-like</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <div id="meDisplay" class="muted">Đang xác minh...</div>
      <button id="btnCreateRoom" class="btn" disabled>Tạo phòng</button>
      <button id="btnLogout" class="btn ghost" style="display:none">Đăng xuất</button>
    </div>
  </header>

  <div class="container">
    <div>
      <div class="card">
        <h2>Danh sách bạn bè</h2>
        <div id="friendsList">Đang tải...</div>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />
        <div>
          <div class="row">
            <input id="searchUser" placeholder="Tìm người (username)">
            <button id="btnSearch" class="btn ghost">Tìm</button>
          </div>
          <div id="searchResults" style="margin-top:10px"></div>
        </div>
      </div>

      <div style="height:18px"></div>
      <div class="card">
        <h2>Hộp thư</h2>
        <div id="inbox">Đang tải...</div>
      </div>
    </div>

    <div>
      <div class="card">
        <h2>Thông tin</h2>
        <div id="profile">Đang tải...</div>
      </div>

      <div style="height:18px"></div>
      <div class="card">
        <h2>Phòng đang hoạt động</h2>
        <div id="roomsArea">Tạo phòng và mời bạn</div>
      </div>
    </div>
  </div>

  <script src="firebase-config.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import {
      getDatabase, ref, set, push, onValue, get, remove
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

    const app = initializeApp(window.FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI elements
    const meDisplay = document.getElementById('meDisplay');
    const btnCreateRoom = document.getElementById('btnCreateRoom');
    const btnLogout = document.getElementById('btnLogout');
    const friendsList = document.getElementById('friendsList');
    const searchUser = document.getElementById('searchUser');
    const btnSearch = document.getElementById('btnSearch');
    const searchResults = document.getElementById('searchResults');
    const inbox = document.getElementById('inbox');
    const profile = document.getElementById('profile');
    const roomsArea = document.getElementById('roomsArea');

    let me = null;
    let firstCheck = true;

    // Utility helpers
    const elt = (t, attrs={}, txt='') => {
      const e = document.createElement(t);
      for(const k in attrs) e.setAttribute(k, attrs[k]);
      if(txt) e.innerText = txt;
      return e;
    };

    function showError(msg){ alert(msg); console.warn(msg); }

    // Wait for auth state properly (prevent immediate redirect)
    onAuthStateChanged(auth, async user => {
      if(user){
        firstCheck = false;
        const uid = user.uid;
        try{
          const snap = await get(ref(db, `users/${uid}`));
          const data = snap.val();
          if(!data){
            showError('Không tìm thấy profile. Về trang đăng nhập.');
            await signOut(auth);
            location.href = 'login.html';
            return;
          }
          me = { uid, username: data.username, displayName: data.displayName };
          meDisplay.innerText = me.displayName;
          btnLogout.style.display = '';
          btnCreateRoom.disabled = false;
          renderProfile(data);
          watchFriends();
          watchInbox();
        }catch(e){
          console.error(e);
          showError('Lỗi khi tải profile.');
        }
      } else {
        // If we've already checked once and there's still no user -> redirect
        if(!firstCheck){
          location.href = 'login.html';
        }
      }
    });

    btnLogout.onclick = async ()=>{ await signOut(auth); localStorage.removeItem('uid'); location.href='login.html'; };

    function renderProfile(data){
      profile.innerHTML = '';
      const name = elt('div', {}, data.displayName || '(No name)');
      const idline = elt('div', {class:'small'}, `@${data.username || ''}`);
      profile.appendChild(name); profile.appendChild(idline);
    }

    // ---------- Friends (watch using onValue) ----------
    function watchFriends(){
      if(!me) return;
      const fRef = ref(db, `users/${me.uid}/friends`);
      onValue(fRef, async snapshot => {
        const val = snapshot.val() || {};
        friendsList.innerHTML = '';
        const ids = Object.keys(val || {});
        if(ids.length === 0){
          friendsList.innerHTML = '<div class="muted">Bạn chưa có bạn bè</div>';
          return;
        }
        // For each friend uid, fetch profile (non-blocking)
        for(const fid of ids){
          try{
            const s = await get(ref(db, `users/${fid}`));
            const u = s.val();
            if(!u) continue;
            const item = elt('div', {class:'userItem'});
            const left = elt('div',{}, `${u.displayName} (${u.username})`);
            const right = elt('div');
            const btnInvite = elt('button', {class:'btn'}, 'Mời');
            btnInvite.onclick = ()=> inviteToRoom(fid);
            right.appendChild(btnInvite);
            item.appendChild(left); item.appendChild(right);
            friendsList.appendChild(item);
          }catch(e){
            console.warn('fetch friend profile failed', e);
          }
        }
      });
    }

    // ---------- Search users (debounced simple) ----------
    let searchTimer = null;
    btnSearch.onclick = ()=> searchNow();
    searchUser.addEventListener('keydown', e=>{ if(e.key==='Enter') searchNow(); });

    async function searchNow(){
      const q = (searchUser.value || '').trim().toLowerCase();
      searchResults.innerHTML = '';
      if(!q) return;
      // Naive approach: read all users (for demo). For production use index or cloud function.
      const snap = await get(ref(db, 'users'));
      const all = snap.val() || {};
      const keys = Object.keys(all);
      for(const uid of keys){
        const u = all[uid];
        if(!u || !u.username) continue;
        if(uid === (me && me.uid)) continue;
        if(u.username.includes(q) || (u.displayName && u.displayName.toLowerCase().includes(q))){
          const row = elt('div', {class:'userItem'});
          row.innerHTML = `<div>${u.displayName} (${u.username})</div>`;
          const btn = elt('button',{class:'btn ghost'}, 'Kết bạn');
          btn.onclick = ()=> sendFriendRequest(uid, u);
          row.appendChild(btn);
          searchResults.appendChild(row);
        }
      }
    }

    // ---------- Send friend request (use push to avoid overwrite) ----------
    async function sendFriendRequest(targetUid, targetUserObj){
      if(!me) return showError('Chưa đăng nhập');
      try{
        const reqRef = ref(db, `friendRequests/${targetUid}`);
        const p = await push(reqRef, {
          from: me.uid,
          fromName: me.displayName,
          fromUsername: me.username,
          time: Date.now()
        });
        // optional: give feedback
        alert('Đã gửi lời mời tới ' + (targetUserObj.displayName || targetUserObj.username));
      }catch(e){
        console.error(e);
        showError('Không thể gửi lời mời');
      }
    }

    // ---------- Inbox: friend requests & invites ----------
    function watchInbox(){
      if(!me) return;
      // friend requests
      const frRef = ref(db, `friendRequests/${me.uid}`);
      onValue(frRef, snapshot => {
        const val = snapshot.val() || {};
        inbox.innerHTML = '<div style="font-weight:700;margin-bottom:6px">Lời mời kết bạn</div>';
        const entries = Object.entries(val || {});
        if(entries.length === 0) inbox.innerHTML += '<div class="muted">Không có lời mời</div>';
        for(const [key, req] of entries){
          const el = elt('div',{class:'inboxItem'});
          el.innerHTML = `<div>${req.fromName} (${req.fromUsername})</div>`;
          const accept = elt('button',{class:'btn'}, 'Chấp nhận');
          const decline = elt('button',{class:'btn ghost'}, 'Từ chối');
          accept.onclick = async ()=>{
            try{
              // add both to friends
              await set(ref(db, `users/${me.uid}/friends/${req.from}`), true);
              await set(ref(db, `users/${req.from}/friends/${me.uid}`), true);
              // remove the request
              await remove(ref(db, `friendRequests/${me.uid}/${key}`));
            }catch(e){ console.error(e); showError('Lỗi khi chấp nhận'); }
          };
          decline.onclick = async ()=> { await remove(ref(db, `friendRequests/${me.uid}/${key}`)); };
          el.appendChild(accept); el.appendChild(decline);
          inbox.appendChild(el);
        }
      });

      // invites to rooms
      const invRef = ref(db, `invites/${me.uid}`);
      onValue(invRef, snapshot=>{
        const val = snapshot.val() || {};
        inbox.innerHTML += '<div style="font-weight:700;margin-top:12px;margin-bottom:6px">Lời mời phòng</div>';
        const entries = Object.entries(val || {});
        if(entries.length === 0) inbox.innerHTML += '<div class="muted">Không có lời mời phòng</div>';
        for(const [k, it] of entries){
          const el = elt('div',{class:'inboxItem'});
          el.innerHTML = `<div>${it.fromName} mời bạn vào phòng <strong>${it.room}</strong></div>`;
          const joinBtn = elt('button',{class:'btn'}, 'Tham gia');
          const ignore = elt('button',{class:'btn ghost'}, 'Bỏ qua');
          joinBtn.onclick = ()=> { location.href = `call.html?room=${encodeURIComponent(it.room)}`; };
          ignore.onclick = ()=> remove(ref(db, `invites/${me.uid}/${k}`));
          el.appendChild(joinBtn); el.appendChild(ignore);
          inbox.appendChild(el);
        }
      });
    }

    // ---------- Create Room (and redirect to call) ----------
    btnCreateRoom.onclick = async ()=>{
      if(!me) return showError('Chưa đăng nhập');
      // create unique room id
      const roomId = 'room_' + Math.random().toString(36).slice(2,9);
      try{
        await set(ref(db, `rooms/${roomId}`), { createdBy: me.uid, createdAt: Date.now() });
        location.href = `call.html?room=${encodeURIComponent(roomId)}`;
      }catch(e){
        console.error(e); showError('Không thể tạo phòng');
      }
    };

    // ---------- Invite to Room (send push invite) ----------
    async function inviteToRoom(targetUid){
      if(!me) return showError('Chưa đăng nhập');
      const room = prompt('Nhập room ID (hoặc tạo phòng trước)');
      if(!room) return;
      try{
        const invRef = ref(db, `invites/${targetUid}`);
        await push(invRef, { from: me.uid, fromName: me.displayName, room, time: Date.now() });
        alert('Đã gửi lời mời');
      }catch(e){ console.error(e); showError('Không thể gửi invite'); }
    }

    // init: enable search only after me loaded
    (function initUi(){
      btnCreateRoom.disabled = true;
      btnSearch.onclick = searchNow;
    })();

    // When me is ready, call watchInbox in onAuthStateChanged above
    // ensure watchInbox is started after me available
    // watchFriends is started similarly

    // tiny helper for manual testing: expose me
    window.__MTMET = { getMe: ()=> me };

  </script>
</body>
</html>

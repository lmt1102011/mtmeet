<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Đăng nhập</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='16' fill='%2312192a'/%3E%3Ctext x='50'%20y='58' font-size='52' text-anchor='middle' fill='%23ffffff' font-family='Arial'%3EM%3C/text%3E%3C/svg%3E">
<style>
body{margin:0;background:#0b1b2b;color:#e8eaed;font-family:Inter,Segoe UI,Arial;display:flex;align-items:center;justify-content:center;height:100vh}
.card{background:#101820;padding:24px;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,0.5);width:300px}
input{width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:none;background:#0b1115;color:#e8eaed}
button{width:100%;padding:10px;border:none;border-radius:8px;background:#2196f3;color:#fff;cursor:pointer}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.1)}
a{color:#2196f3;text-decoration:none;display:block;text-align:center;margin-top:12px}
</style>
</head>
<body>

<div class="card">
<h2>Đăng nhập</h2>
<input type="text" id="username" placeholder="Tên đăng nhập">
<input type="password" id="password" placeholder="Mật khẩu">
<button id="btnLogin">Đăng nhập</button>
<a href="register.html">Chưa có tài khoản? Đăng ký</a>
<div id="msg" style="margin-top:8px;font-size:13px;color:#f44"></div>
</div>

<script src="firebase-config.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

const app = initializeApp(window.FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getDatabase(app);

const username = document.getElementById('username');
const password = document.getElementById('password');
const btnLogin = document.getElementById('btnLogin');
const msg = document.getElementById('msg');

btnLogin.onclick = async ()=>{
  const u = username.value.trim();
  const p = password.value;
  if(!u || !p){ msg.innerText='Vui lòng nhập đủ thông tin'; return; }
  
  try {
    msg.innerText='Đang đăng nhập...';
    msg.style.color='#9fb0bd';
    
    // Get user by username to find email
    const usersSnap = await get(ref(db, 'users'));
    const users = usersSnap.val() || {};
    let userEmail = null;
    let displayName = null;
    
    for(const uid in users){
      if(users[uid].username === u){
        userEmail = users[uid].email;
        displayName = users[uid].displayName;
        break;
      }
    }
    
    if(!userEmail){
      msg.style.color='#f44';
      msg.innerText='Tên đăng nhập không tồn tại';
      return;
    }
    
    // Login with email and password
    await signInWithEmailAndPassword(auth, userEmail, p);
    msg.style.color='#4caf50';
    msg.innerText='Đăng nhập thành công!';
    setTimeout(() => location.href='index.html', 1000);
  } catch(e){
    console.error('Login error:', e);
    msg.style.color='#f44';
    if(e.code === 'auth/wrong-password' || e.code === 'auth/invalid-email') {
      msg.innerText='Tên đăng nhập hoặc mật khẩu không đúng';
    } else if(e.message && e.message.toLowerCase().includes('permission')) {
      msg.innerText='Lỗi quyền truy cập dữ liệu. Vui lòng kiểm tra cấu hình Firebase.';
    } else {
      msg.innerText='Lỗi đăng nhập: ' + (e.message || e.code);
    }
  }
};

onAuthStateChanged(auth, user=>{
  if(user) location.href="index.html";
});
</script>
</body>
</html>

<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MTMET — Video Call PRO</title>
<style>
:root{--bg:#0b1b2b;--surface:#12161a;--accent:#2196f3;--muted:#9fb0bd;--text:#e8eaed;--danger:#b71c1c;--tile-radius:14px}
body{margin:0;height:100vh;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Arial;display:flex;flex-direction:column}
header{display:flex;align-items:center;gap:12px;padding:12px 18px;background:linear-gradient(90deg,rgba(33,150,243,0.06),transparent);border-bottom:1px solid rgba(255,255,255,0.03)}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#64b5f6);display:flex;align-items:center;justify-content:center;font-weight:700}
.header-right{margin-left:auto;display:flex;gap:8px;align-items:center}
#roomTitle{font-weight:700}
#meInfo{font-size:13px;color:var(--muted)}
#inviteBtn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:8px;border-radius:8px;cursor:pointer}
#stageWrap{flex:1;overflow:auto;padding:16px}
#stage{display:grid;gap:12px;align-content:start}
.tile{background:#000;border-radius:var(--tile-radius);overflow:hidden;position:relative;min-height:150px;display:flex;align-items:center;justify-content:center}
.tile video{width:100%;height:100%;object-fit:cover;display:block}
.tile .avatar{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:700;background:linear-gradient(135deg,#263238,#37474f);color:#fff}
.tile .bottomBar{position:absolute;left:12px;right:12px;bottom:12px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.badge{background:rgba(0,0,0,0.45);padding:6px 10px;border-radius:10px;font-weight:600;color:var(--text)}
.micDot{width:10px;height:10px;border-radius:50%;background:#6b6b6b;margin-left:8px;box-shadow:0 0 0 0 rgba(0,0,0,0)}
.micOn{background:#00e676;box-shadow:0 0 8px rgba(0,230,118,0.18)}
.controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--surface);padding:12px 14px;border-radius:40px;display:flex;gap:10px;box-shadow:0 10px 60px rgba(0,0,0,0.6);z-index:40}
.controlBtn{width:56px;height:56px;border-radius:50%;border:none;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
.controlBtn.dim{filter:grayscale(60%) brightness(0.6)}
.controlBtn.danger{background:var(--danger)}
.controlBtn.no-perm{background:#4e1a1a}
.controlBtn.mic-active{box-shadow:0 0 18px rgba(0,230,118,0.22);}
.popup{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;z-index:999}
.popup.hidden{display:none}
.popupContent{width:360px;max-height:75vh;background:var(--surface);border-radius:14px;overflow:auto;padding:14px;box-shadow:0 0 40px rgba(0,0,0,0.4)}
.popupHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-size:18px;font-weight:600}
.closeBtn{border:none;background:transparent;color:var(--muted);font-size:18px;cursor:pointer}
.friendList .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:8px}
.friendAvatar{width:40px;height:40px;background:linear-gradient(135deg,#455a64,#607d8b);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px}
.inviteBtn{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#fff}
.inviteBtn.sent{background:#4e1a1a;cursor:not-allowed}
@media (min-width:1400px){#stage{grid-template-columns:repeat(4,1fr)}}
@media (max-width:1399px) and (min-width:900px){#stage{grid-template-columns:repeat(3,1fr)}}
@media (max-width:899px) and (min-width:600px){#stage{grid-template-columns:repeat(2,1fr)}}
@media (max-width:599px){#stage{grid-template-columns:repeat(1,1fr)}}
.small{font-size:13px;color:var(--muted)}
.hidden{display:none}
</style>
</head>
<body>

<header>
  <div class="logo">M</div>
  <div>
    <div id="roomTitle">Room</div>
    <div id="meInfo" class="small">...</div>
  </div>
  <div class="header-right">
    <div id="meName" class="small"></div>
    <button id="inviteBtn">Invite</button>
  </div>
</header>

<div id="stageWrap"><div id="stage" role="region" aria-live="polite"></div></div>

<div class="controls" role="toolbar" aria-label="call controls">
  <button id="requestPermBtn" class="controlBtn" title="Enable Camera & Mic">SET</button>
  <button id="muteBtn" class="controlBtn dim" title="Toggle mic">MIC</button>
  <button id="camBtn" class="controlBtn dim" title="Toggle cam">CAM</button>
  <button id="leaveBtn" class="controlBtn danger" title="Leave">✖</button>
</div>

<!-- Invite Popup -->
<div id="invitePopup" class="popup hidden" aria-hidden="true">
  <div class="popupContent">
    <div class="popupHeader">
      <div>Chọn bạn để mời</div>
      <button id="closeInvite" class="closeBtn">✖</button>
    </div>
    <div id="friendList" class="friendList"></div>
  </div>
</div>

<script src="firebase-config.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
import { getDatabase, ref, set, push, onValue, onChildAdded, remove, get } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

const app = initializeApp(window.FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getDatabase(app);

const stage = document.getElementById('stage');
const meInfo = document.getElementById('meInfo');
const meName = document.getElementById('meName');
const inviteBtn = document.getElementById('inviteBtn');
const requestPermBtn = document.getElementById('requestPermBtn');
const muteBtn = document.getElementById('muteBtn');
const camBtn = document.getElementById('camBtn');
const leaveBtn = document.getElementById('leaveBtn');

const invitePopup = document.getElementById('invitePopup');
const friendListDiv = document.getElementById('friendList');
const closeInvite = document.getElementById('closeInvite');

let roomId = new URL(location.href).searchParams.get('room') || "demo-room";
let me = null;
let localStream = null;
let localMicEnabled = false;
let localCamEnabled = false;
let permissionDeniedCam = false;
let permissionDeniedMic = false;
let pcs = {};
let tiles = {};
let audioAnalyzers = {};

const elt = (t, attrs={}, txt='') => { const e=document.createElement(t); for(const k in attrs) e.setAttribute(k,attrs[k]); if(txt) e.innerText=txt; return e; };
function relayout(){ const count=Object.keys(tiles).length||1; const w=stage.clientWidth; let cols=1; if(w>=1400) cols=Math.min(4,count); else if(w>=900) cols=Math.min(3,count); else if(w>=600) cols=Math.min(2,count); else cols=1; stage.style.gridTemplateColumns=`repeat(${cols},1fr)`;}
window.addEventListener('resize',relayout);

function createTile(uid,name){
  if(tiles[uid]) return tiles[uid];
  const tile = elt('div',{class:'tile'});
  const video = elt('video',{autoplay:true,playsinline:true});
  const avatar = elt('div',{class:'avatar'}, name[0].toUpperCase());
  const bottomBar = elt('div',{class:'bottomBar'});
  const badge = elt('div',{class:'badge'},name);
  const micDot = elt('div',{class:'micDot'});
  bottomBar.appendChild(badge); bottomBar.appendChild(micDot);
  tile.appendChild(video); tile.appendChild(avatar); tile.appendChild(bottomBar);
  stage.appendChild(tile);
  tiles[uid]={el:tile,video,avatar,badge,micDot};
  relayout();
  return tiles[uid];
}

function requestPermissions(){
  navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(stream=>{
    localStream = stream;
    localCamEnabled = true; 
    localMicEnabled = true;
    tiles['me'] = createTile('me', me.displayName || "Me");
    tiles['me'].video.srcObject = localStream;
    camBtn.classList.remove('dim','no-perm');
    muteBtn.classList.remove('dim','no-perm');
    startMicAnalyzer('me', localStream);
    joinRoom();
  }).catch(e=>{
    console.error('getUserMedia error:', e);
    if(e.name==="NotAllowedError"){
      permissionDeniedCam = true;
      permissionDeniedMic = true;
      camBtn.classList.add('no-perm');
      muteBtn.classList.add('no-perm');
      alert("Vui lòng cấp quyền Camera & Micro để tham gia phòng!");
    } else if(e.name==="NotFoundError"){
      alert("Không tìm thấy camera hoặc microphone!");
    } else {
      alert("Lỗi: " + e.message);
    }
  });
}

muteBtn.onclick = ()=>{
  if(!localStream || permissionDeniedMic) return;
  localMicEnabled=!localMicEnabled;
  localStream.getAudioTracks()[0].enabled=localMicEnabled;
};
camBtn.onclick = ()=>{
  if(!localStream || permissionDeniedCam) return;
  localCamEnabled=!localCamEnabled;
  localStream.getVideoTracks()[0].enabled=localCamEnabled;
};
leaveBtn.onclick = ()=>{ Object.values(pcs).forEach(pc=>pc.close()); location.href="index.html"; };

requestPermBtn.onclick = requestPermissions;

inviteBtn.onclick=()=>{ invitePopup.classList.remove('hidden'); invitePopup.setAttribute('aria-hidden','false'); loadFriends(); }
closeInvite.onclick=()=>{ invitePopup.classList.add('hidden'); invitePopup.setAttribute('aria-hidden','true'); }
async function loadFriends(){
  friendListDiv.innerHTML='<div style="color:#ccc;padding:10px;">Đang tải...</div>';
  try {
    if (!me || !me.uid) {
      friendListDiv.innerHTML = '<div style="color:#f44;padding:10px;">Chưa đăng nhập!</div>';
      return;
    }
    
    const friendsRef = ref(db, `users/${me.uid}/friends`);
    const snapshot = await get(friendsRef);
    const friendUids = snapshot.val() || {};
    const friendKeys = Object.keys(friendUids);
    
    console.log('Friends found:', friendKeys.length, friendKeys);
    
    if (friendKeys.length === 0) {
      friendListDiv.innerHTML = '<div style="color:#999;padding:10px;">Chưa có bạn bè. Hãy kết bạn trên trang danh sách bạn bè trước!</div>';
      return;
    }
    
    friendListDiv.innerHTML = '';
    for (const friendUid of friendKeys) {
      const userRef = ref(db, `users/${friendUid}`);
      const userSnap = await get(userRef);
      const friendData = userSnap.val();
      if (!friendData) continue;
      
      const item = elt('div', {class:'item'});
      const avatar = elt('div', {class:'friendAvatar'}, (friendData.displayName || 'U')[0]);
      const name = elt('div', {}, friendData.displayName || 'Unknown');
      const btn = elt('button', {class:'inviteBtn'}, 'Mời');
      
      btn.onclick = async () => {
        try {
          const roomId = new URLSearchParams(location.search).get('room');
          const inviteData = { 
            from: me.uid, 
            fromName: me.displayName, 
            room: roomId,
            time: Date.now() 
          };
          const inviteKey = 'i_' + Math.random().toString(36).slice(2,9);
          await set(ref(db, `invites/${friendUid}/${inviteKey}`), inviteData);
          btn.classList.add('sent'); 
          btn.innerText='Đã gửi'; 
          btn.disabled=true;
        } catch (err) {
          console.error('Send invite error:', err);
          alert('Lỗi gửi mời: ' + err.message);
        }
      };
      
      item.appendChild(avatar);
      item.appendChild(name);
      item.appendChild(btn);
      friendListDiv.appendChild(item);
    }
  } catch (e) {
    console.error('Load friends error:', e);
    friendListDiv.innerHTML = '<div style="color:#f44;padding:10px;">Lỗi: ' + e.message + '</div>';
  }
}

onAuthStateChanged(auth,user=>{
  if(!user){ location.href="/login.html"; return; }
  me=user;
  meName.innerText=user.displayName||"Me";
  meInfo.innerText=user.uid;
});

function joinRoom(){
  const participantsRef = ref(db, 'rooms/'+roomId+'/participants');
  const signalsRef = ref(db, 'rooms/'+roomId+'/signals');
  set(ref(db,'rooms/'+roomId+'/participants/'+me.uid), {name: me.displayName||"Me"} );

  onValue(participantsRef, snapshot=>{
    const data = snapshot.val()||{};
    Object.keys(data).forEach(uid=>{
      if(uid===me.uid) return;
      if(!pcs[uid]) {
        const participantName = data[uid]?.name || 'User';
        createPeer(uid, participantName);
      }
    });
    Object.keys(tiles).forEach(uid=>{
      if(uid!=='me' && !data[uid]){ tiles[uid].el.remove(); delete tiles[uid]; pcs[uid]?.close(); delete pcs[uid]; }
    });
  });

  onChildAdded(signalsRef, snapshot=>{
    const s = snapshot.val();
    if(!s || s.to!==me.uid) return;
    handleSignal(s.from, s.type, s.data);
    remove(ref(db,'rooms/'+roomId+'/signals/'+snapshot.key));
  });
}

function createPeer(uid, name){
  const pc = new RTCPeerConnection();
  pcs[uid]=pc;
  tiles[uid]=createTile(uid, name || uid);

  if(localStream) localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));

  pc.ontrack = e=>{
    tiles[uid].video.srcObject = e.streams[0];
    startMicAnalyzer(uid,e.streams[0]);
  };

  pc.onicecandidate = e=>{
    if(e.candidate){
      push(ref(db,'rooms/'+roomId+'/signals'),{
        from:me.uid,to:uid,type:'candidate',data:e.candidate.toJSON()
      });
    }
  };

  pc.createOffer().then(offer=>{
    pc.setLocalDescription(offer);
    push(ref(db,'rooms/'+roomId+'/signals'),{
      from:me.uid,to:uid,type:'offer',data:offer.toJSON()
    });
  });
}

function handleSignal(from,type,data){
  let pc = pcs[from];
  if(!pc){ createPeer(from); pc=pcs[from]; }
  if(type==='offer'){
    pc.setRemoteDescription(new RTCSessionDescription(data)).then(()=>{
      pc.createAnswer().then(answer=>{
        pc.setLocalDescription(answer);
        push(ref(db,'rooms/'+roomId+'/signals'),{
          from:me.uid,to:from,type:'answer',data:answer.toJSON()
        });
      });
    });
  } else if(type==='answer'){
    pc.setRemoteDescription(new RTCSessionDescription(data));
  } else if(type==='candidate'){
    pc.addIceCandidate(new RTCIceCandidate(data));
  }
}

// Mic activity indicator
function startMicAnalyzer(uid,stream){
  const audioCtx = new AudioContext();
  const source = audioCtx.createMediaStreamSource(stream);
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = 512;
  source.connect(analyser);
  const data = new Uint8Array(analyser.frequencyBinCount);
  audioAnalyzers[uid] = analyser;
  function tick(){
    analyser.getByteFrequencyData(data);
    const volume = data.reduce((a,b)=>a+b,0)/data.length;
    if(tiles[uid]) tiles[uid].micDot.classList.toggle('micOn',volume>30);
    requestAnimationFrame(tick);
  }
  tick();
}
</script>
</body>
</html>

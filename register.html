<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Đăng ký</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='16' fill='%2312192a'/%3E%3Ctext x='50'%20y='58' font-size='52' text-anchor='middle' fill='%23ffffff' font-family='Arial'%3EM%3C/text%3E%3C/svg%3E">
<style>
body{margin:0;background:#0b1b2b;color:#e8eaed;font-family:Inter,Segoe UI,Arial;display:flex;align-items:center;justify-content:center;height:100vh}
.card{background:#101820;padding:24px;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,0.5);width:300px}
input{width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:none;background:#0b1115;color:#e8eaed}
button{width:100%;padding:10px;border:none;border-radius:8px;background:#2196f3;color:#fff;cursor:pointer}
a{color:#2196f3;text-decoration:none;display:block;text-align:center;margin-top:12px}
</style>
</head>
<body>

<div class="card">
<h2>Đăng ký</h2>
<input type="text" id="username" placeholder="Tên đăng nhập">
<input type="text" id="displayName" placeholder="Tên hiển thị">
<input type="password" id="password" placeholder="Mật khẩu">
<button id="btnRegister">Đăng ký</button>
<a href="login.html">Quay lại đăng nhập</a>
<div id="msg" style="margin-top:8px;font-size:13px;color:#f44"></div>
</div>

<script src="firebase-config.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, deleteUser } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
import { getDatabase, ref, get, set, runTransaction, remove } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

const app = initializeApp(window.FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getDatabase(app);

const username = document.getElementById('username');
const displayName = document.getElementById('displayName');
const password = document.getElementById('password');
const btnRegister = document.getElementById('btnRegister');
const msg = document.getElementById('msg');

btnRegister.onclick = async ()=>{
  const u = username.value.trim();
  const d = displayName.value.trim();
  const p = password.value;
  if(!u||!d||!p){ msg.innerText='Nhập đủ thông tin'; return; }

  try {
    msg.innerText='Đang đăng ký...';
    msg.style.color='#9fb0bd';

    // Ensure username is not taken (public usernameIndex)
    const existing = await get(ref(db, `usernameIndex/${u}`));
    if(existing && existing.exists && existing.exists()){ msg.style.color='#f44'; msg.innerText='Tên đăng nhập đã tồn tại'; return; }

    // Create Firebase auth user with email=username@app.local
    const email = u + '@app.local';
    const userCred = await createUserWithEmailAndPassword(auth, email, p);
    const uid = userCred.user.uid;
    
    console.log('✓ Auth user created:', uid);

    // Attempt to reserve the username atomically using a transaction on usernameIndex/{u}
    const idxRef = ref(db, `usernameIndex/${u}`);
    try{
      const txResult = await runTransaction(idxRef, current => {
        if(current === null) return { uid: uid, email: email };
        return; // abort transaction (username taken)
      }, { applyLocally: false });

      if(!txResult.committed){
        // Username was taken concurrently — roll back created auth user
        try{ await deleteUser(userCred.user); }catch(_){/* ignore */}
        msg.style.color='#f44'; msg.innerText='Tên đăng nhập đã tồn tại (đã bị người khác lấy)';
        return;
      }

      // Transaction succeeded — now write the user profile
      await set(ref(db, `users/${uid}`), {
        username: u,
        displayName: d,
        email: email,
        friends: {}
      });
      console.log('✓ Username reserved and user profile written');

    }catch(ixErr){
      console.warn('Error reserving username or writing profile:', ixErr);
      // Try best-effort cleanup: remove usernameIndex if it points to this uid, and delete auth user
      try{
        const snap = await get(idxRef);
        const val = snap.val();
        if(val && val.uid === uid){ await remove(idxRef); }
      }catch(_){/* ignore cleanup errors */}
      try{ await deleteUser(userCred.user); console.log('Rolled back auth user'); }catch(delErr){ console.error('Failed to delete orphaned auth user:', delErr); }
      throw ixErr;
    }
    
    console.log('✓ User data saved to DB');

    msg.innerText='Đăng ký thành công!';
    msg.style.color='#4caf50';
    setTimeout(() => location.href='login.html', 1500);
  } catch(e) {
    console.error('Register error:', e);
    msg.style.color='#f44';
    
    if(e.code === 'auth/email-already-in-use') {
      msg.innerText='Tên đăng nhập đã tồn tại';
    } else if(e.code === 'auth/weak-password') {
      msg.innerText='Mật khẩu quá yếu (tối thiểu 6 ký tự)';
    } else if(e.code === 'auth/invalid-email') {
      msg.innerText='Email không hợp lệ';
    } else if(e.message && e.message.toLowerCase().includes('permission')) {
      msg.innerText='Lỗi quyền truy cập. Vui lòng kiểm tra cấu hình Firebase.';
    } else {
      msg.innerText='Lỗi: ' + (e.message || e.code);
    }
  }
};

onAuthStateChanged(auth, user=>{
  if(user) location.href="index.html";
});
</script>
</body>
</html>

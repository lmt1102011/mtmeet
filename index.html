<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MTMET — Danh sách bạn bè</title>
<style>
:root{--bg:#0b1b2b;--surface:#101820;--accent:#2196f3;--muted:#9fb0bd;--card-radius:12px;--text:#e8eaed}
body{margin:0;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:var(--text)}
header{display:flex;align-items:center;gap:12px;padding:18px;background:linear-gradient(90deg,rgba(33,150,243,0.06),transparent);box-shadow:0 6px 20px rgba(0,0,0,0.4)}
.logo{width:44px;height:44;border-radius:10px;background:linear-gradient(135deg,var(--accent),#64b5f6);display:flex;align-items:center;justify-content:center;font-weight:800}
.container{max-width:1100px;margin:18px auto;display:grid;grid-template-columns:320px 1fr;gap:18px;padding:0 16px}
.card{background:var(--surface);padding:16px;border-radius:var(--card-radius);box-shadow:0 8px 40px rgba(0,0,0,0.5)}
h2{margin:0 0 10px}
.userItem,.inboxItem{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
.btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
.btn:hover{opacity:0.95}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent)}
.muted{color:var(--muted)}
input{width:100%;padding:8px;border-radius:8px;background:#0b1115;border:1px solid #17202a;color:var(--text)}
.sectionTitle{font-weight:700;margin-bottom:6px}
.small{font-size:13px;color:var(--muted)}
/* Room modal */
#roomModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:1000}
#roomContent{background:#101820;padding:20px;border-radius:12px;width:90%;max-width:800px;display:flex;flex-direction:column;gap:10px}
#localVideo,#remoteVideo{width:100%;border-radius:12px;background:#000}
.controls{display:flex;gap:10px;margin-top:10px;justify-content:center}
.controlBtn{padding:10px;border-radius:50%;border:none;background:#444;color:white;cursor:pointer;position:relative}
.controlBtn.active::after{content:"";position:absolute;top:-4px;right:-4px;width:12px;height:12px;background:limegreen;border-radius:50%}
.controlBtn.disabled{background:#222;cursor:not-allowed}
</style>
</head>
<body>
<header>
  <div class="logo">M</div>
  <div>
    <div style="font-weight:700">MTMET</div>
    <div style="font-size:12px;color:var(--muted)">Gọi nhóm • Giao diện Meet-like</div>
  </div>
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
    <div id="meDisplay" class="muted">Đang xác minh...</div>
    <button id="btnCreateRoom" class="btn" disabled>Tạo phòng</button>
    <button id="btnLogout" class="btn ghost" style="display:none">Đăng xuất</button>
  </div>
</header>

<div class="container">
  <div>
    <div class="card">
      <h2>Danh sách bạn bè</h2>
      <div id="friendsList">Đang tải...</div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.05);margin:12px 0"/>
      <div class="row">
        <input id="searchUser" placeholder="Tìm người (username)">
        <button id="btnSearch" class="btn ghost">Tìm</button>
      </div>
      <div id="searchResults" style="margin-top:10px"></div>
    </div>

    <div style="height:18px"></div>
    <div class="card">
      <h2>Hộp thư</h2>
      <div id="friendInbox">Đang tải...</div>
      <div style="height:12px"></div>
      <div id="roomInbox"></div>
    </div>
  </div>

  <div>
    <div class="card">
      <h2>Thông tin</h2>
      <div id="profile">Đang tải...</div>
    </div>

    <div style="height:18px"></div>
    <div class="card">
      <h2>Phòng đang hoạt động</h2>
      <div id="roomsArea">Tạo phòng và mời bạn</div>
    </div>
  </div>
</div>

<!-- Room Modal -->
<div id="roomModal">
  <div id="roomContent">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <div class="controls">
      <button id="btnMic" class="controlBtn disabled">Mic</button>
      <button id="btnCam" class="controlBtn disabled">Cam</button>
      <button id="btnLeave" class="controlBtn">Rời phòng</button>
    </div>
  </div>
</div>


<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script src="firebase-config.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
import { getDatabase, ref, set, push, onValue, get, remove } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

if(!window.FIREBASE_CONFIG) alert('Chưa load FIREBASE_CONFIG!');

const app = initializeApp(window.FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getDatabase(app);

const meDisplay = document.getElementById('meDisplay');
const btnCreateRoom = document.getElementById('btnCreateRoom');
const btnLogout = document.getElementById('btnLogout');
const friendsList = document.getElementById('friendsList');
const searchUser = document.getElementById('searchUser');
const btnSearch = document.getElementById('btnSearch');
const searchResults = document.getElementById('searchResults');
const friendInbox = document.getElementById('friendInbox');
const roomInbox = document.getElementById('roomInbox');
const profile = document.getElementById('profile');

let me = null;
let firstCheck = true;

const elt = (t,a={},txt='')=>{const e=document.createElement(t);for(const k in a)e.setAttribute(k,a[k]);if(txt)e.innerText=txt;return e;}
function showError(msg){console.warn(msg);alert(msg);}

onAuthStateChanged(auth,user=>{
  if(user){
    firstCheck=false;
    const uid=user.uid;
    get(ref(db,`users/${uid}`)).then(snap=>{
      const data=snap.val();
      if(!data){signOut(auth); return location.href='login.html';}
      me={uid,username:data.username,displayName:data.displayName};
      meDisplay.innerText=me.displayName;
      btnLogout.style.display='';
      btnCreateRoom.disabled=false;
      profile.innerHTML=`<div><strong>${data.displayName}</strong></div><div class="small">@${data.username}</div>`;
      watchFriends();
      watchInbox();
    });
  } else {
    if(!firstCheck) location.href='login.html';
  }
});

btnLogout.onclick=async()=>{await signOut(auth); location.href='login.html';};

// Friend list
function watchFriends(){
  onValue(ref(db,`users/${me.uid}/friends`),async snap=>{
    const val=snap.val()||{};
    friendsList.innerHTML='';
    const ids=Object.keys(val);
    if(ids.length===0){friendsList.innerHTML='<div class="muted">Chưa có bạn bè</div>'; return;}
    for(const fid of ids){
      const data=(await get(ref(db,`users/${fid}`))).val();
      if(!data) continue;
      const row=elt('div',{class:'userItem'});
      row.innerHTML=`<div>${data.displayName} (${data.username})</div>`;
      const btn=elt('button',{class:'btn'},'Mời');
      btn.onclick=()=>inviteToRoom(fid);
      row.appendChild(btn);
      friendsList.appendChild(row);
    }
  });
}

// Search
btnSearch.onclick=searchNow;
searchUser.onkeydown=e=>{if(e.key==='Enter') searchNow();};
async function searchNow(){
  const q=searchUser.value.trim().toLowerCase();
  searchResults.innerHTML='';
  if(!q) return;
  const all=(await get(ref(db,'users'))).val()||{};
  for(const [uid,u] of Object.entries(all)){
    if(uid===me.uid) continue;
    if(!u.username.toLowerCase().includes(q)&&!(u.displayName||'').toLowerCase().includes(q)) continue;
    const row=elt('div',{class:'userItem'});
    row.innerHTML=`<div>${u.displayName} (${u.username})</div>`;
    if(u.friends && u.friends[me.uid]){
      row.appendChild(elt('div',{class:'muted'},'Đã kết bạn'));
    } else {
      const btn=elt('button',{class:'btn ghost'},'Kết bạn');
      btn.onclick=()=>sendFriendRequest(uid,u);
      row.appendChild(btn);
    }
    searchResults.appendChild(row);
  }
}
async function sendFriendRequest(uid,u){await push(ref(db,`friendRequests/${uid}`),{from:me.uid,fromName:me.displayName,fromUsername:me.username,time:Date.now()}); alert('Đã gửi lời mời');}

// Inbox
function watchInbox(){
  onValue(ref(db,`friendRequests/${me.uid}`),snap=>{
    const val=snap.val()||{};
    friendInbox.innerHTML='<div class="sectionTitle">Lời mời kết bạn</div>';
    const entries=Object.entries(val);
    if(entries.length===0) friendInbox.innerHTML+='<div class="muted">Không có</div>';
    entries.forEach(([k,it])=>{
      const row=elt('div',{class:'inboxItem'});
      row.innerHTML=`<div>${it.fromName} (${it.fromUsername})</div>`;
      const ac=elt('button',{class:'btn'},'Chấp nhận');
      ac.onclick=async()=>{
        await set(ref(db,`users/${me.uid}/friends/${it.from}`),true);
        await set(ref(db,`users/${it.from}/friends/${me.uid}`),true);
        await remove(ref(db,`friendRequests/${me.uid}/${k}`));
      };
      const de=elt('button',{class:'btn ghost'},'Từ chối');
      de.onclick=()=>remove(ref(db,`friendRequests/${me.uid}/${k}`));
      row.appendChild(ac); row.appendChild(de);
      friendInbox.appendChild(row);
    });
  });

  onValue(ref(db,`invites/${me.uid}`),snap=>{
    const val=snap.val()||{};
    roomInbox.innerHTML='<div class="sectionTitle">Lời mời phòng</div>';
    const entries=Object.entries(val);
    if(entries.length===0) roomInbox.innerHTML+='<div class="muted">Không có</div>';
    entries.forEach(([k,it])=>{
      const row=elt('div',{class:'inboxItem'});
      row.innerHTML=`<div>${it.fromName} mời vào <strong>${it.room}</strong></div>`;
      const join=elt('button',{class:'btn'},'Tham gia');
      join.onclick=()=>enterRoom(it.room);
      const ignore=elt('button',{class:'btn ghost'},'Bỏ qua');
      ignore.onclick=()=>remove(ref(db,`invites/${me.uid}/${k}`));
      row.appendChild(join); row.appendChild(ignore);
      roomInbox.appendChild(row);
    });
  });
}

// Create Room
btnCreateRoom.onclick=async()=>{
  const roomId='room_'+Math.random().toString(36).slice(2,9);
  await set(ref(db,`rooms/${roomId}`),{createdBy:me.uid,createdAt:Date.now()});
  enterRoom(roomId);
};

async function inviteToRoom(uid){
  const room=prompt('Nhập room ID');
  if(!room) return;
  await push(ref(db,`invites/${uid}`),{from:me.uid,fromName:me.displayName,room,time:Date.now()});
  alert('Đã mời');
}

// Room / mic-cam
const roomModal=document.getElementById('roomModal');
const localVideo=document.getElementById('localVideo');
const remoteVideo=document.getElementById('remoteVideo');
const btnMic=document.getElementById('btnMic');
const btnCam=document.getElementById('btnCam');
const btnLeave=document.getElementById('btnLeave');
let localStream=null;

async function enterRoom(roomId){
  roomModal.style.display='flex';
  try{
    localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:true});
    localVideo.srcObject=localStream;
    btnMic.classList.add('active'); btnCam.classList.add('active'); 
  } catch(e){
    console.warn('Không có quyền mic/cam',e);
    btnMic.classList.remove('active'); btnCam.classList.remove('active');
    btnMic.classList.add('disabled'); btnCam.classList.add('disabled');
  }
}

btnMic.onclick=()=>{
  if(btnMic.classList.contains('disabled')) return alert('Chưa cấp quyền mic!');
  const audioTrack=localStream.getAudioTracks()[0];
  audioTrack.enabled=!audioTrack.enabled;
  btnMic.classList.toggle('active',audioTrack.enabled);
};

btnCam.onclick=()=>{
  if(btnCam.classList.contains('disabled')) return alert('Chưa cấp quyền camera!');
  const videoTrack=localStream.getVideoTracks()[0];
  videoTrack.enabled=!videoTrack.enabled;
  btnCam.classList.toggle('active',videoTrack.enabled);
};

btnLeave.onclick=()=>{roomModal.style.display='none'; if(localStream){localStream.getTracks().forEach(t=>t.stop());}}
</script>
</body>
</html>

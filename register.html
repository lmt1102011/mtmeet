<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Đăng ký</title>
<style>
body{margin:0;background:#0b1b2b;color:#e8eaed;font-family:Inter,Segoe UI,Arial;display:flex;align-items:center;justify-content:center;height:100vh}
.card{background:#101820;padding:24px;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,0.5);width:300px}
input{width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:none;background:#0b1115;color:#e8eaed}
button{width:100%;padding:10px;border:none;border-radius:8px;background:#2196f3;color:#fff;cursor:pointer}
a{color:#2196f3;text-decoration:none;display:block;text-align:center;margin-top:12px}
</style>
</head>
<body>

<div class="card">
<h2>Đăng ký</h2>
<input type="text" id="username" placeholder="Tên đăng nhập">
<input type="text" id="displayName" placeholder="Tên hiển thị">
<input type="password" id="password" placeholder="Mật khẩu">
<button id="btnRegister">Đăng ký</button>
<a href="login.html">Quay lại đăng nhập</a>
<div id="msg" style="margin-top:8px;font-size:13px;color:#f44"></div>
</div>

<script src="firebase-config.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

const app = initializeApp(window.FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getDatabase(app);

const username = document.getElementById('username');
const displayName = document.getElementById('displayName');
const password = document.getElementById('password');
const btnRegister = document.getElementById('btnRegister');
const msg = document.getElementById('msg');

btnRegister.onclick = async ()=>{
  const u = username.value.trim();
  const d = displayName.value.trim();
  const p = password.value;
  if(!u||!d||!p){ msg.innerText='Nhập đủ thông tin'; return; }

  try {
    // Check if username already exists
    const usersSnap = await get(ref(db, 'users'));
    const users = usersSnap.val() || {};
    for(const uid in users){
      if(users[uid].username === u){ 
        msg.innerText='Tên đăng nhập đã tồn tại'; 
        return; 
      }
    }

    // Create Firebase auth user with email=username@app.local
    const email = u + '@app.local';
    const userCred = await createUserWithEmailAndPassword(auth, email, p);
    const uid = userCred.user.uid;

    // Save user data to database
    await set(ref(db, `users/${uid}`), {
      username: u,
      displayName: d,
      email: email,
      friends: {}
    });

    msg.innerText='Đăng ký thành công!';
    msg.style.color='#4caf50';
    setTimeout(() => location.href='login.html', 1500);
  } catch(e) {
    console.error('Register error:', e);
    if(e.code === 'auth/email-already-in-use') {
      msg.innerText='Email đã được dùng';
    } else {
      msg.innerText='Lỗi: ' + e.message;
    }
  }
};

onAuthStateChanged(auth, user=>{
  if(user) location.href="index.html";
});
</script>
</body>
</html>

<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đăng ký — MTMET</title>
  <link rel="stylesheet" href="auth.css">
</head>
<body>
  <div class="auth-box">
    <h2>Đăng ký</h2>
    <input id="displayName" placeholder="Tên hiển thị" autocomplete="off">
    <input id="username" placeholder="Tên đăng nhập" autocomplete="off">
    <input id="password" placeholder="Mật khẩu" type="password">
    <button id="btnRegister">Tạo tài khoản</button>
    <div id="msg"></div>
    <p>Đã có tài khoản? <a href="login.html">Đăng nhập</a></p>
  </div>

  <script src="firebase-config.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

    const app = initializeApp(window.FIREBASE_CONFIG);
    const db = getDatabase(app);

    const btn = document.getElementById('btnRegister');
    const msg = document.getElementById('msg');
    
    btn.onclick = register;

    async function register(){
      msg.innerText = '';

      let displayName = displayName.value.trim();
      let username = username.value.trim().toLowerCase();
      let password = password.value;

      if(!displayName || !username || !password){
        msg.innerText = "Nhập đầy đủ thông tin";
        return;
      }

      // Kiểm tra username đã tồn tại chưa
      const snap = await get(ref(db, 'users'));
      const allUsers = snap.val() || {};
      if(Object.values(allUsers).some(u => u.username === username)){
        msg.innerText = "Tên đăng nhập đã tồn tại!";
        return;
      }

      // Generate salt
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveBits"]);
      const bits = await crypto.subtle.deriveBits({
        name: "PBKDF2",
        salt,
        iterations: 100000,
        hash: "SHA-256"
      }, key, 256);

      const hashArray = Array.from(new Uint8Array(bits));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
      const saltHex = Array.from(salt).map(b=>b.toString(16).padStart(2,'0')).join('');

      // Tạo UID ngẫu nhiên
      const uid = 'u_' + Math.random().toString(36).slice(2,10);

      await set(ref(db, `users/${uid}`), {
        username,
        displayName,
        passwordHash: hashHex,
        salt: saltHex
      });

      // Lưu session
      localStorage.setItem('uid', uid);

      location.href = "index.html";
    }
  </script>
</body>
</html>
